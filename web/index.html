<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebRTC éŸ³é¢‘å›ç¯ Demo</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  button { padding: 6px 12px; margin-right: 10px; }
  #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 200px; overflow: auto; margin-top: 10px; }
</style>
</head>
<body>
<h2>WebRTC éŸ³é¢‘å›ç¯ Demo</h2>
<button id="startBtn">å¼€å§‹</button>
<button id="stopBtn">åœæ­¢</button>
<div id="log"></div>

<script>
const logEl = document.getElementById('log');
function log(...args) {
  logEl.textContent += args.join(' ') + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

let pc = null;
let localStream = null;
let remoteAudio = null;


document.getElementById('startBtn').onclick = async () => {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    log('è·å–æœ¬åœ°éŸ³é¢‘æµ');

    // æå‰åˆ›å»ºä¸€ä¸ª audio å…ƒç´ ï¼Œç¡®ä¿ç”¨æˆ·ç‚¹å‡»è§¦å‘
    remoteAudio = document.createElement('audio');
    remoteAudio.autoplay = true;
    remoteAudio.controls = true;
    remoteAudio.muted = false;
    remoteAudio.play().catch(err => log('æ’­æ”¾å¤±è´¥:', err));
    document.body.appendChild(remoteAudio);

    pc = new RTCPeerConnection({
      iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }, {
        urls:       ["turn:115.190.139.89:3478"],
        username:   "uwebrtc",
        credential: "prtcweb",
      }]
    }); 
    setInterval(async () => {
      if (!pc) return;
      const stats = await pc.getStats();
      stats.forEach(report => {
        if (report.type === "inbound-rtp" && report.kind === "audio") {
          console.log("Inbound packetsReceived:", report.packetsReceived);
          console.log("Inbound bytesReceived:", report.bytesReceived);
        }
      });
    }, 2000);
    pc.ontrack = (event) => {
      log('æ”¶åˆ°è¿œç«¯éŸ³é¢‘ track');
      remoteAudio.srcObject = event.streams[0]; // ğŸ”‘ ç›´æ¥å¤ç”¨å·²æœ‰ audio
    };

    for (const track of localStream.getAudioTracks()) {
      pc.addTrack(track, localStream);
    }

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const response = await fetch('/offer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: offer.type, sdp: offer.sdp })
    });

    const answer = await response.json();
    await pc.setRemoteDescription(answer);
    log('è®¾ç½®è¿œç«¯ Answer å®Œæˆï¼Œå›ç¯å»ºç«‹'); 

    pc.onconnectionstatechange = () => {
      log('PeerConnection çŠ¶æ€: ' + pc.connectionState);
    };

    // ç›‘å¬ ICE å€™é€‰çš„å˜åŒ–
    pc.onicecandidate = function (event) {
      console.log('ICE Candidate: ', event.candidate);
      if (event.candidate) {
        console.log('ICE Candidate: ', event.candidate);
        // å°† ICE candidate å‘é€åˆ°æœåŠ¡å™¨
        // sendCandidateToServer(event.candidate);
      } else {
        console.log('ICE candidate gathering complete');
      }
    };
    // ç›‘å¬ ICE è¿æ¥çŠ¶æ€å˜åŒ–
    pc.oniceconnectionstatechange = function (event) {
      console.log(
        'ICE Connection State has changed: ',
        pc.iceConnectionState,
      );
      // å¯ä»¥æ ¹æ®çŠ¶æ€å¤„ç†é€»è¾‘ï¼Œä¾‹å¦‚è¿æ¥å¤±è´¥æ—¶é‡æ–°å°è¯•è¿æ¥
      if (pc.iceConnectionState === 'failed') {
        console.log(
          'ICE Connection failed. Please check the network and NAT configuration.',
        );
      }
    };
    // ç›‘å¬ ICE Gathering çŠ¶æ€å˜åŒ–
    pc.onicegatheringstatechange = function (event) {
      console.log(
        'ICE Gathering State has changed: ',
        pc.iceGatheringState,
      );
      // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨æ­¤å¤„ç†ç‰¹å®šçš„æ”¶é›†çŠ¶æ€ï¼Œå¦‚ `gathering` æˆ– `complete`
      if (pc.iceGatheringState === 'complete') {
        console.log('ICE gathering completed.');
      }
    };

  } catch (err) {
    log('é”™è¯¯:', err);
  }
};

document.getElementById('stopBtn').onclick = () => {
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }
  if (pc) {
    pc.close();
    pc = null;
  }
  log('åœæ­¢å›ç¯');
};
</script>
</body>
</html>
