<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC éŸ³é¢‘å›ç¯ Demo</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { padding: 6px 12px; margin-right: 10px; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 200px; overflow: auto; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>WebRTC éŸ³é¢‘å›ç¯ Demo</h2>
  <button id="startBtn">å¼€å§‹</button>
  <button id="stopBtn">åœæ­¢</button>
  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    function log(...args) {
      logEl.textContent += args.join(' ') + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    let pc = null;
    let localStream = null;
    let remoteAudio = null;

    document.getElementById('startBtn').onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        log('è·å–æœ¬åœ°éŸ³é¢‘æµ');

        // æå‰åˆ›å»ºä¸€ä¸ª audio å…ƒç´ ï¼Œç¡®ä¿ç”¨æˆ·ç‚¹å‡»è§¦å‘
        remoteAudio = document.createElement('audio');
        remoteAudio.autoplay = true;
        remoteAudio.controls = true;
        remoteAudio.muted = false;
        remoteAudio.play().catch(err => log('æ’­æ”¾å¤±è´¥:', err));
        document.body.appendChild(remoteAudio);

        pc = new RTCPeerConnection({
          iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }]
        });

        setInterval(async () => {
          if (!pc) return;
          const stats = await pc.getStats();
          stats.forEach(report => {
            if (report.type === "inbound-rtp" && report.kind === "audio") {
              console.log("Inbound packetsReceived:", report.packetsReceived);
              console.log("Inbound bytesReceived:", report.bytesReceived);
            }
          });
        }, 2000);

        pc.ontrack = (event) => {
          log('æ”¶åˆ°è¿œç«¯éŸ³é¢‘ track');
          remoteAudio.srcObject = event.streams[0]; // ğŸ”‘ ç›´æ¥å¤ç”¨å·²æœ‰ audio
        };

        for (const track of localStream.getAudioTracks()) {
          pc.addTrack(track, localStream);
        }

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // ä¿®æ”¹ POST è¯·æ±‚åœ°å€å’Œå¤´éƒ¨ä¿¡æ¯
        const response = await fetch('http://dcarx.dcarlife.net/motor/llm/agent_phone/dcc_phone_rtc', {
          method: 'POST',
          headers: {
            'Host':'dcarx.dcarlife.net',
            'x-tt-env': 'ppe_feat_newcar_tool',
            'x-use-ppe': '1'
          },
          body: JSON.stringify({ type: offer.type, sdp: offer.sdp })
        });

        const answer = await response.json();
        await pc.setRemoteDescription(answer);
        log('è®¾ç½®è¿œç«¯ Answer å®Œæˆï¼Œå›ç¯å»ºç«‹');

        pc.onconnectionstatechange = () => {
          log('PeerConnection çŠ¶æ€: ' + pc.connectionState);
        };

      } catch (err) {
        log('é”™è¯¯:', err);
      }
    };

    document.getElementById('stopBtn').onclick = () => {
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      if (pc) {
        pc.close();
        pc = null;
      }
      log('åœæ­¢å›ç¯');
    };
  </script>
</body>
</html>
